<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°—æƒ…å ±ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    
    <style>
        /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            background-color: #f5f5f5;
            text-align: center;
            padding: 20px;
        }

        /* å¤©æ°—æƒ…å ±ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .weather-container {
            max-width: 400px;
            margin: 20px auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        /* ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .custom-btn {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
            transition: 0.3s;
        }

        .custom-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        /* å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .weather-icon {
            width: 100px;
            height: auto;
            display: block;
            margin: 10px auto;
        }
    </style>
</head>
<body>
    <!-- ç¾åœ¨åœ°ã®å¤©æ°—å–å¾—ãƒœã‚¿ãƒ³ -->
    <button class="btn btn-success custom-btn w-100 mt-2" onclick="fetchWeatherByLocation()">ğŸ“ ç¾åœ¨åœ°ã®å¤©æ°—</button>

    <h1 class="md-3">ğŸŒ¤ å¤©æ°—æƒ…å ±ã‚¢ãƒ—ãƒª</h1>

    <!-- å¤©æ°—æƒ…å ±ã®å…¥åŠ›ãƒ»è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="weather-container">
        <input type="text" id="city" class="form-control mb-2" placeholder="éƒ½å¸‚åã‚’å…¥åŠ›">
        <button class="btn btn-primary custom-btn w-100" onclick="fetchWeather()">å–å¾—</button>
        <div id="weatherResult" class="mt-3"></div>
        <div id="history" class="mt-3"></div>  <!-- å±¥æ­´è¡¨ç¤ºç”¨ -->
    </div>

    <script>
        // ã€ŒEnterã€ã‚­ãƒ¼ã§æ¤œç´¢ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        document.getElementById("city").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                fetchWeather();
            }
        });

        // æ¤œç´¢å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆ©ç”¨ï¼‰
        function saveHistory(city) {
            let history = JSON.parse(localStorage.getItem("weatherHistory")) || [];

            // åŒã˜éƒ½å¸‚åã‚’é‡è¤‡ã—ã¦ä¿å­˜ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            history = history.filter(item => item !== city);
            history.unshift(city); // å…ˆé ­ã«è¿½åŠ 

            // å±¥æ­´ã‚’æœ€å¤§5ä»¶ã¾ã§ã«åˆ¶é™
            if (history.length > 5) {
                history.pop();
            }

            localStorage.setItem("weatherHistory", JSON.stringify(history));
            displayHistory();
        }

        // å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayHistory() {
            const historyDiv = document.getElementById("history");
            historyDiv.innerHTML = ""; 

            let history = JSON.parse(localStorage.getItem("weatherHistory")) || [];

            history.forEach(city => {
                const button = document.createElement("button");
                button.textContent = city;
                button.classList.add("btn", "btn-outline-secondary", "m-1");
                button.onclick = () => {
                    document.getElementById("city").value = city;
                    fetchWeather();
                };
                historyDiv.appendChild(button);
            });
        }

        // ç¾åœ¨åœ°ã®å¤©æ°—ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchWeatherByLocation() {
            if (!navigator.geolocation) {
                alert("GPSãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    const response = await fetch(`http://127.0.0.1:5000/weather?lat=${lat}&lon=${lon}`);
                    const data = await response.json();

                    if (data.error) {
                        document.getElementById("weatherResult").innerHTML = `<p style="color: red;">âš  ${data.error}</p>`;
                        return;
                    }

                    document.getElementById("weatherResult").innerHTML = `
                        <h3>ç¾åœ¨åœ°ã®å¤©æ°—</h3>
                        <img src="${getWeatherIcon(data["å¤©æ°—"])}" alt="å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³">
                        <p><strong>å¤©æ°—:</strong> ${data["å¤©æ°—"]}</p>
                        <p><strong>æ°—æ¸©:</strong> ${data["æ°—æ¸© (Â°C)"]}Â°C</p>
                        <p><strong>æ¹¿åº¦:</strong> ${data["æ¹¿åº¦ (%)"]}%</p>
                        <p><strong>é¢¨é€Ÿ:</strong> ${data["é¢¨é€Ÿ (m/s)"]}m/s</p>
                    `;

                } catch (error) {
                    console.error("ã‚¨ãƒ©ãƒ¼:", error);
                    document.getElementById("weatherResult").innerHTML = `<p style="color: red;">âš  ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
                }
            }, (error) => {
                alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            });
        }

        // å…¥åŠ›ã—ãŸéƒ½å¸‚åã§å¤©æ°—ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchWeather() {
            const city = document.getElementById("city").value.trim();
            if (!city) return;
            
            saveHistory(city); // å±¥æ­´ã«ä¿å­˜

            try {
                const encodedCity = encodeURIComponent(city);
                const response = await fetch(`http://127.0.0.1:5000/weather/${encodedCity}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById("weatherResult").innerHTML = `<p style="color: red;">âš  ${data.error}</p>`;
                    return;
                }

                document.getElementById("weatherResult").innerHTML = `
                    <h3>${data["éƒ½å¸‚"]}</h3>
                    <img src="${getWeatherIcon(data["å¤©æ°—"])}" alt="å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³">
                    <p><strong>å¤©æ°—:</strong> ${data["å¤©æ°—"]}</p>
                    <p><strong>æ°—æ¸©:</strong> ${data["æ°—æ¸© (Â°C)"]}Â°C</p>
                    <p><strong>æ¹¿åº¦:</strong> ${data["æ¹¿åº¦ (%)"]}%</p>
                    <p><strong>é¢¨é€Ÿ:</strong> ${data["é¢¨é€Ÿ (m/s)"]}m/s</p>
                `;

            } catch (error) {
                console.error("ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById("weatherResult").innerHTML = `<p style="color: red;">âš  ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            }
        }

        // å¤©æ°—ã®èª¬æ˜ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getWeatherIcon(description) {
            const icons = {
                "æ™´ã‚Œ": "https://openweathermap.org/img/wn/01d.png",
                "æ›‡ã‚Š": "https://openweathermap.org/img/wn/02d.png",
                "é›¨": "https://openweathermap.org/img/wn/09d.png",
                "é›·é›¨": "https://openweathermap.org/img/wn/11d.png",
                "é›ª": "https://openweathermap.org/img/wn/13d.png"
            };
            return icons[description] || "https://openweathermap.org/img/wn/50d.png";
        }

    function updateBackground(weather, hour) {
      let bgImage = "";

        if (hour >= 6 && hour < 10) {  // æœ
            if (weather.includes("æ™´")) {
            bgImage = "url('./images/morning-sky.jpg')";
        } else if (weather.includes("æ›‡")) {
            bgImage = "url('./images/cloudy-morning.jpg')";
        } else if (weather.includes("é›¨")) {
            bgImage = "url('./images/rainy-morning.jpg')";
        } else if (weather.includes("é›ª")) {
            bgImage = "url('./images/snowy-morning.jpg')";
        }
    } else if (hour >= 10 && hour < 16) {  // æ˜¼
        if (weather.includes("æ™´")) {
            bgImage = "url('./images/blue-sky.jpg')";
        } else if (weather.includes("æ›‡")) {
            bgImage = "url('./images/cloudy.jpg')";
        } else if (weather.includes("é›¨")) {
            bgImage = "url('./images/rain.jpg')";
        } else if (weather.includes("é›ª")) {
            bgImage = "url('./images/snow.jpg')";
        }
    } else if (hour >= 16 && hour < 18) {  // å¤•æ–¹
        if (weather.includes("æ™´")) {
            bgImage = "url('./images/sunset.jpg')";
        } else if (weather.includes("æ›‡")) {
            bgImage = "url('./images/cloudy-sunset.jpg')";
        } else if (weather.includes("é›¨")) {
            bgImage = "url('./images/rainy-sunset.jpg')";
        } else if (weather.includes("é›ª")) {
            bgImage = "url('./images/snowy-sunset.jpg')";
        }
    } else if (hour >= 18 && hour < 22) {  // å¤œ
        if (weather.includes("æ™´")) {
            bgImage = "url('./images/night-sky.jpg')";
        } else if (weather.includes("æ›‡")) {
            bgImage = "url('./images/cloudy-night.jpg')";
        } else if (weather.includes("é›¨")) {
            bgImage = "url('./images/rainy-night.jpg')";
        } else if (weather.includes("é›ª")) {
            bgImage = "url('./images/snowy-night.jpg')";
        }
    } else {  // æ·±å¤œ
        if (weather.includes("æ™´")) {
            bgImage = "url('./images/stars.jpg')";
        } else if (weather.includes("æ›‡")) {
            bgImage = "url('./images/cloudy-midnight.jpg')";
        } else if (weather.includes("é›¨")) {
            bgImage = "url('./images/rainy-midnight.jpg')";
        } else if (weather.includes("é›ª")) {
            bgImage = "url('./images/snowy-midnight.jpg')";
        }
    }

    // èƒŒæ™¯ã‚’é©ç”¨
    document.body.style.backgroundImage = bgImage;
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundPosition = "center";
}

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å±¥æ­´ã‚’è¡¨ç¤º
        window.onload = displayHistory;
    
    </script>

</body>
</html>
